sudo: required
services: docker
dist: trusty
language: c

matrix:
  include:
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 CC=clang-6.0 CXX=clang++-6.0
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 COVERAGE=t ARGS="--with-flux-security --with-pmix --enable-caliper --enable-pylint"
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 T_INSTALL=t
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 CPPCHECK=t ARGS="--with-flux-security --with-pmix --enable-sanitizer" CC=clang-6.0 CXX=clang++-6.0
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 CC=gcc-8 CXX=g++-8 ARGS="--with-flux-security --with-pmix" chain_lint=t
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 ARGS="--with-flux-security --with-pmix --enable-caliper" CC=clang-6.0 CXX=clang++-6.0
      
cache:
  directories:
    - $HOME/.ccache

script:
 - mkdir -p ~/.ccache
 - |
   docker run --rm --user='root' -v $HOME:/home/flux -v ${TRAVIS_BUILD_DIR}:/usr/src fluxrm/testenv:$IMG chown -R flux /home/flux /usr/src
   docker run --rm -w /usr/src -v $HOME:/home/flux/ -v ${TRAVIS_BUILD_DIR}:/usr/src -e CC,CXX,COVERAGE,CPPFLAGS,ARGS,T_INSTALL,CPPCHECK,chain_lint,LUA_VERSION,ASAN_OPTIONS,TRAVIS_PULL_REQUEST -e LSAN_OPTIONS -e COMPILER -e DO_BUILD -e DO_TEST fluxrm/testenv:$IMG ./src/test/travis_run.sh

after_success:
 - ccache -s

after_failure:
 - find . -name test-suite.log | xargs -i sh -c 'printf "===XXX {} XXX===";cat {}'
 - find . -name t[0-9]*.output | xargs -i sh -c 'printf "\033[31mFound {}\033[39m\n";cat {}'
 - find . -name *.broker.log | xargs -i sh -c 'printf "\033[31mFound {}\033[39m\n";cat {}'
 - src/test/backtrace-all.sh
 - grep -q 'configure: exit 1' config.log && cat config.log
 # Issue #997 debugging
 - cat src/common/libflux/test_reactor.log

before_deploy:
  # Get anchor (formatted properly) and base URI for latest tag in NEWS file
  - export ANCHOR=$(sed -n '/^flux-core version/{s/\.//g; s/\s/-/gp;Q}' NEWS.md)
  - export TAG_URI="https://github.com/${TRAVIS_REPO_SLUG}/blob/${TRAVIS_TAG}"
  - export TARBALL=$(echo flux-core*.tar.gz)
  - ls -l $TARBALL
  - echo "Deploying tag ${TRAVIS_TAG} as $TARBALL"

deploy:
  provider: releases
  skip_cleanup: true
  file: $TARBALL
  prerelease: true
  body: "View [Release Notes](${TAG_URI}/NEWS.md#${ANCHOR}) for flux-core ${TRAVIS_TAG}"
  api_key:
    secure: I7ckZ7Ei9oLIe8WZ8OH3EgZz81IFCIekx+v/+g3sJa6q15URlfZhVVFtiUpsJRktHcb39AflWZiEIX+HdUZyXtuTt9IES1XBIKH7x/zUL0x6f1DZKAhBx9ktYzdO/M+SpmDUg6RYxcdjVmSHZ9u935TDo104U+dY0990ZSFrpco=
  on:
    # Only deploy from first job in build matrix
    condition: $TRAVIS_JOB_NUMBER = $TRAVIS_BUILD_NUMBER.1
    tags: true
    repo: flux-framework/flux-core
