sudo: required
services: docker
dist: trusty
language: c

matrix:
  include:
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 CC=clang-6.0 CXX=clang++-6.0
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 COVERAGE=t ARGS="--with-flux-security --with-pmix --enable-caliper --enable-pylint"
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 T_INSTALL=t
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 CPPCHECK=t ARGS="--with-flux-security --with-pmix --enable-sanitizer" CC=clang-6.0 CXX=clang++-6.0
    - compiler: gcc
      env: IMG=bionic-base LUA_VERSION=5.2 CC=gcc-8 CXX=g++-8 ARGS="--with-flux-security --with-pmix" chain_lint=t
    - compiler: clang
      env: IMG=clang6 LUA_VERSION=5.2 ARGS="--with-flux-security --with-pmix --enable-caliper" CC=clang-6.0 CXX=clang++-6.0
      
cache:
  directories:
    - $HOME/.ccache

addons:
  coverity_scan:
    project:
      name: "grondo/flux-core"
      description: "Build submitted via Travis CI"
    notification_email: mark.grondona@gmail.com
    build_command_prepend: "./autogen.sh && ./configure"
    build_command:   "make -j 4"
    branch_pattern: coverity_scan

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "T06LmG6hAwmRculQGfmV06A0f2i9rPoc8itDwyWkmg2CbtCqDyYV93V53jsVknqKA1LA9+Yo7Q3bJnnEAWI7kWAptTcL5ipRycYkl5FqoYawkwRdQW3giZwbs9zRchrwFmZ03N0hRfl31IntXhDmj5EkHOZoduMpkQFFGo0XDC4="

before_install:
  # Do not run coverity-scan on every build in matrix
  - test "${TRAVIS_BRANCH}" != 'coverity_scan' -o "${TRAVIS_JOB_NUMBER##*.}" = '1' || exit 0
  #
  - test "$TRAVIS_PULL_REQUEST" == "false" || export CCACHE_READONLY=1
  - if test "$CC" = "clang"; then export CCACHE_CPP2=1; fi

  - rm -rf $HOME/.luarocks
  - $(./src/test/travis-dep-builder.sh --printenv)
  - ./src/test/travis-dep-builder.sh --cachedir=$HOME/local/.cache

  # coveralls-lcov required only for coveralls upload:
  - if test "$COVERAGE" = "t" ; then gem install coveralls-lcov; fi

  # Ensure we always use internal <flux/core.h> by placing a dummy file
  #  in the same path as ZMQ_FLAGS:
  - mkdir -p $HOME/local/include/flux
  - echo '#error Non-build-tree flux/core.h!' > $HOME/local/include/flux/core.h

script:
 - mkdir -p ~/.ccache
 - |
   if test "$COVERITY_SCAN_BRANCH" != "1" ; then
     docker run --rm --user='root' -v $HOME:/home/flux -v ${TRAVIS_BUILD_DIR}:/usr/src fluxrm/testenv:$IMG chown -R flux /home/flux /usr/src
     docker run --rm -w /usr/src -v $HOME:/home/flux/ -v ${TRAVIS_BUILD_DIR}:/usr/src -e CC,CXX,CCACHE_CPP2,CCACHE_READONLY,COVERAGE,CPPFLAGS,ARGS,T_INSTALL,CPPCHECK,chain_lint,LUA_VERSION,ASAN_OPTIONS -e LSAN_OPTIONS -e COMPILER -e DO_BUILD -e DO_TEST fluxrm/testenv:$IMG ./src/test/travis_run.sh
   fi

after_success:
 - ccache -s
 # Upload results to coveralls.io for first job of N
 - if test "$COVERAGE" = "t" ; then coveralls-lcov flux*-coverage.info; bash <(curl -s https://codecov.io/bash) ; fi

after_failure:
 - find . -name test-suite.log | xargs -i sh -c 'printf "===XXX {} XXX===";cat {}'
 - find . -name t[0-9]*.output | xargs -i sh -c 'printf "\033[31mFound {}\033[39m\n";cat {}'
 - find . -name *.broker.log | xargs -i sh -c 'printf "\033[31mFound {}\033[39m\n";cat {}'
 - src/test/backtrace-all.sh
 - grep -q 'configure: exit 1' config.log && cat config.log
 # Issue #997 debugging
 - cat src/common/libflux/test_reactor.log

before_deploy:
  # Get anchor (formatted properly) and base URI for latest tag in NEWS file
  - export ANCHOR=$(sed -n '/^flux-core version/{s/\.//g; s/\s/-/gp;Q}' NEWS.md)
  - export TAG_URI="https://github.com/${TRAVIS_REPO_SLUG}/blob/${TRAVIS_TAG}"
  - export TARBALL=$(echo flux-core*.tar.gz)
  - ls -l $TARBALL
  - echo "Deploying tag ${TRAVIS_TAG} as $TARBALL"

deploy:
  provider: releases
  skip_cleanup: true
  file: $TARBALL
  prerelease: true
  body: "View [Release Notes](${TAG_URI}/NEWS.md#${ANCHOR}) for flux-core ${TRAVIS_TAG}"
  api_key:
    secure: I7ckZ7Ei9oLIe8WZ8OH3EgZz81IFCIekx+v/+g3sJa6q15URlfZhVVFtiUpsJRktHcb39AflWZiEIX+HdUZyXtuTt9IES1XBIKH7x/zUL0x6f1DZKAhBx9ktYzdO/M+SpmDUg6RYxcdjVmSHZ9u935TDo104U+dY0990ZSFrpco=
  on:
    # Only deploy from first job in build matrix
    condition: $TRAVIS_JOB_NUMBER = $TRAVIS_BUILD_NUMBER.1
    tags: true
    repo: flux-framework/flux-core
