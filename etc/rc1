#!/bin/bash -e

# Allow connector-local more time to start listening on socket
FLUX_LOCAL_CONNECTOR_RETRY_COUNT=10 rank=$(flux getattr rank)

if test $rank -eq 0; then
    backingmod=$(flux getattr content.backing-module 2>/dev/null) || true
    flux module load ${backingmod:-content-sqlite}
fi

flux module load barrier
flux module load aggregator
flux module load kvs
flux module load kvs-watch
flux module load cron sync=hb

if test $rank -eq 0; then
    flux module load resource
    flux module load job-info
    flux module load job-manager
    flux module load job-exec
    flux module load sched-simple
fi

flux module load job-ingest

core_dir=$(cd ${0%/*} && pwd -P)
all_dirs=$core_dir${FLUX_RC_EXTRA:+":$FLUX_RC_EXTRA"}
IFS=:
shopt -s nullglob
for rcdir in $all_dirs; do
    for rcfile in $rcdir/rc1.d/*; do
	echo running $rcfile
        $rcfile
    done
done
shopt -u nullglob

test $rank -ne 0 || flux admin cleanup-push <<-EOT
	flux queue stop --quiet
	flux job cancelall --user=all --quiet -f --states RUN
	flux queue idle --quiet
EOT
