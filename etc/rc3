#!/bin/bash

rank=$(flux getattr rank)

core_dir=$(cd ${0%/*} && pwd -P)
all_dirs=$core_dir${FLUX_RC_EXTRA:+":$FLUX_RC_EXTRA"}

IFS=:
shopt -s nullglob
for rcdir in $all_dirs; do
    for rcfile in $rcdir/rc3.d/*; do
        echo running $rcfile
        $rcfile
    done
done
shopt -u nullglob

if test $rank -eq 0; then
    flux module remove -f sched-simple
    flux module remove -f resource
    flux module remove -f job-exec
    flux module remove -f job-manager
fi

flux module remove -f job-ingest

flux module remove -f cron
flux module remove -f aggregator
flux module remove -f barrier

flux module remove -f job-info
flux module remove -f kvs-watch
flux module remove -f kvs

flux content flush

if test $rank -eq 0; then
    backingmod=$(flux getattr content.backing-module 2>/dev/null) || true
    flux module remove -f ${backingmod:-content-sqlite}
fi
